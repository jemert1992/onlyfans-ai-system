<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - OnlyFans AI Communication System</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    {% extends "base.html" %}
    
    {% block content %}
    <div class="row">
        <div class="col-md-12">
            <h1>Dashboard</h1>
            <p>Welcome to your OnlyFans AI Communication System dashboard.</p>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    Message Statistics
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <span>Total Messages:</span>
                        <span id="total-messages">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Safe Messages:</span>
                        <span id="safe-messages">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Low-Risk Messages:</span>
                        <span id="low-risk-messages">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>High-Risk Messages:</span>
                        <span id="high-risk-messages">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    Response Statistics
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <span>Total Responses:</span>
                        <span id="total-responses">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Automated Responses:</span>
                        <span id="auto-responses">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Manual Responses:</span>
                        <span id="manual-responses">0</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Response Rate:</span>
                        <span id="response-rate">0%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    Quick Actions
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="/messages" class="btn btn-primary">View Messages</a>
                        <a href="/settings" class="btn btn-secondary">Adjust Settings</a>
                        <a href="/style" class="btn btn-info">Customize Response Style</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-warning">
                    Recent Messages
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Sender</th>
                                    <th>Message</th>
                                    <th>Risk Level</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="recent-messages">
                                <tr>
                                    <td colspan="6" class="text-center">Loading messages...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endblock %}
    
    {% block scripts %}
    <script>
        // Check if user is logged in
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
        }
        
        // Fetch dashboard data
        async function fetchDashboardData() {
            try {
                const response = await fetch('/api/messages/', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch messages');
                }
                
                const data = await response.json();
                updateDashboard(data.messages);
            } catch (error) {
                console.error('Error fetching dashboard data:', error);
            }
        }
        
        // Update dashboard with fetched data
        function updateDashboard(messages) {
            // Count messages by risk level
            const totalMessages = messages.length;
            const safeMessages = messages.filter(m => m.risk_level === 'safe').length;
            const lowRiskMessages = messages.filter(m => m.risk_level === 'low_risk').length;
            const highRiskMessages = messages.filter(m => m.risk_level === 'high_risk').length;
            
            // Count responses
            const respondedMessages = messages.filter(m => m.is_responded);
            const totalResponses = respondedMessages.length;
            const autoResponses = respondedMessages.filter(m => m.responses.some(r => r.is_automated)).length;
            const manualResponses = totalResponses - autoResponses;
            const responseRate = totalMessages > 0 ? Math.round((totalResponses / totalMessages) * 100) : 0;
            
            // Update statistics
            document.getElementById('total-messages').textContent = totalMessages;
            document.getElementById('safe-messages').textContent = safeMessages;
            document.getElementById('low-risk-messages').textContent = lowRiskMessages;
            document.getElementById('high-risk-messages').textContent = highRiskMessages;
            
            document.getElementById('total-responses').textContent = totalResponses;
            document.getElementById('auto-responses').textContent = autoResponses;
            document.getElementById('manual-responses').textContent = manualResponses;
            document.getElementById('response-rate').textContent = `${responseRate}%`;
            
            // Update recent messages table
            const recentMessagesTable = document.getElementById('recent-messages');
            recentMessagesTable.innerHTML = '';
            
            const recentMessages = messages.slice(0, 5); // Show 5 most recent messages
            
            if (recentMessages.length === 0) {
                recentMessagesTable.innerHTML = '<tr><td colspan="6" class="text-center">No messages yet</td></tr>';
                return;
            }
            
            recentMessages.forEach(message => {
                const row = document.createElement('tr');
                
                // Add risk level class
                if (message.risk_level === 'high_risk') {
                    row.classList.add('table-danger');
                } else if (message.risk_level === 'low_risk') {
                    row.classList.add('table-warning');
                }
                
                const date = new Date(message.created_at).toLocaleString();
                const status = message.is_responded ? 'Responded' : 'Pending';
                const statusClass = message.is_responded ? 'text-success' : 'text-danger';
                
                row.innerHTML = `
                    <td>${message.sender_name}</td>
                    <td>${message.content.substring(0, 50)}${message.content.length > 50 ? '...' : ''}</td>
                    <td>${message.risk_level}</td>
                    <td>${date}</td>
                    <td class="${statusClass}">${status}</td>
                    <td><a href="/messages/${message.id}" class="btn btn-sm btn-primary">View</a></td>
                `;
                
                recentMessagesTable.appendChild(row);
            });
        }
        
        // Load dashboard data on page load
        document.addEventListener('DOMContentLoaded', fetchDashboardData);
    </script>
    {% endblock %}
</body>
</html>
